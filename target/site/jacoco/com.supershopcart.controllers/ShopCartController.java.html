<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShopCartController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">supershopcart</a> &gt; <a href="index.source.html" class="el_package">com.supershopcart.controllers</a> &gt; <span class="el_source">ShopCartController.java</span></div><h1>ShopCartController.java</h1><pre class="source lang-java linenums">package com.supershopcart.controllers;

import com.supershopcart.dtos.ShareCartRequestDTO;
import com.supershopcart.dtos.ShopCartDetailDTO;
import com.supershopcart.enums.SharePermission;
import com.supershopcart.models.Shopper;
import com.supershopcart.services.FirestoreService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(&quot;/api/carts&quot;)
@Validated   // Enable validation for path variables etc if needed
public class ShopCartController {

<span class="fc" id="L31">    private static final Logger logger = LoggerFactory.getLogger(ShopCartController.class);</span>

    private final FirestoreService firestoreService;

<span class="fc" id="L35">    public ShopCartController(FirestoreService firestoreService) {</span>
<span class="fc" id="L36">        this.firestoreService = firestoreService;</span>
<span class="fc" id="L37">    }</span>

    @Operation(summary = &quot;Get the current authenticated shopper's carts&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;List of carts retrieved successfully&quot;)
    })
    @GetMapping(&quot;/mine&quot;)
    public List&lt;ShopCartDetailDTO&gt; getMyCarts(@AuthenticationPrincipal Shopper shopper) throws Exception {
<span class="fc" id="L45">        logger.info(&quot;Fetching carts for shopper with ID: {}&quot;, shopper.getId());</span>
<span class="fc" id="L46">        return firestoreService.getShopCartsByShopperId(shopper.getId());</span>
    }

    /**
     * Share a cart with another shopper
     */
    @Operation(summary = &quot;Share a cart with another shopper&quot;,
            description = &quot;Grants sharing permission to another shopper by email&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Cart shared successfully&quot;,
                    content = @Content(schema = @Schema(implementation = Map.class))),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Failed to share cart due to invalid input or permission&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })

    @PostMapping(&quot;/{cartId}/share&quot;)
    public ResponseEntity&lt;?&gt; shareCart(
            @PathVariable String cartId,
            @Valid @RequestBody ShareCartRequestDTO request,
            Authentication authentication) {
        try {
<span class="fc" id="L67">            Shopper currentShopper = (Shopper) authentication.getPrincipal();</span>
<span class="fc" id="L68">            logger.info(&quot;Shopper {} is attempting to share cart {} with {} (permission: {})&quot;,</span>
<span class="fc" id="L69">                    currentShopper.getId(), cartId, request.getTargetShopperEmail(), request.getPermission());</span>

            // Here you may want to verify the currentShopper has rights on this cart before sharing
            // For example:
            // if (!firestoreService.canModifyCart(currentShopper.getId(), cartId)) {
            //     logger.warn(&quot;Shopper {} has no permission to share cart {}&quot;, currentShopper.getId(), cartId);
            //     return ResponseEntity.status(HttpStatus.FORBIDDEN)
            //          .body(Map.of(&quot;error&quot;, &quot;No permission to share this cart&quot;));
            // }

<span class="fc" id="L79">            boolean success = firestoreService.shareCartWithShopper(</span>
                    cartId,
<span class="fc" id="L81">                    currentShopper.getId(),</span>
<span class="fc" id="L82">                    request.getTargetShopperEmail(),</span>
<span class="fc" id="L83">                    request.getPermission()</span>
            );

<span class="fc bfc" id="L86" title="All 2 branches covered.">            if (success) {</span>
<span class="fc" id="L87">                logger.info(&quot;Cart {} shared successfully by shopper {}&quot;, cartId, currentShopper.getId());</span>
<span class="fc" id="L88">                return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Cart shared successfully&quot;));</span>
            } else {
<span class="fc" id="L90">                logger.warn(&quot;Failed to share cart {} by shopper {}&quot;, cartId, currentShopper.getId());</span>
<span class="fc" id="L91">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L92">                        .body(Map.of(&quot;error&quot;, &quot;Failed to share cart. Check permissions and target user exists.&quot;));</span>
            }

<span class="fc" id="L95">        } catch (Exception e) {</span>
<span class="fc" id="L96">            logger.error(&quot;Error sharing cart {}: {}&quot;, cartId, e.getMessage(), e);</span>
<span class="fc" id="L97">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L98">                    .body(Map.of(&quot;error&quot;, &quot;Internal server error: &quot; + e.getMessage()));</span>
        }
    }

    /**
     * Remove sharing permission
     */
    @Operation(summary = &quot;Remove sharing permission from a cart for a target shopper&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Sharing removed successfully&quot;,
                    content = @Content(schema = @Schema(implementation = Map.class))),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Failed to remove sharing&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @DeleteMapping(&quot;/{cartId}/share/{targetShopperId}&quot;)
    public ResponseEntity&lt;?&gt; removeSharing(
            @PathVariable String cartId,
            @PathVariable String targetShopperId,
            Authentication authentication) {
        try {
<span class="fc" id="L118">            Shopper currentShopper = (Shopper) authentication.getPrincipal();</span>
<span class="fc" id="L119">            logger.info(&quot;Shopper {} is attempting to remove sharing of cart {} from shopper {}&quot;,</span>
<span class="fc" id="L120">                    currentShopper.getId(), cartId, targetShopperId);</span>

            // Optionally check permission similarly as in shareCart method

<span class="fc" id="L124">            boolean success = firestoreService.removeCartSharing(cartId, currentShopper.getId(), targetShopperId);</span>

<span class="fc bfc" id="L126" title="All 2 branches covered.">            if (success) {</span>
<span class="fc" id="L127">                logger.info(&quot;Sharing removed successfully for cart {} by shopper {}&quot;, cartId, currentShopper.getId());</span>
<span class="fc" id="L128">                return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Sharing removed successfully&quot;));</span>
            } else {
<span class="fc" id="L130">                logger.warn(&quot;Failed to remove sharing for cart {} by shopper {}&quot;, cartId, currentShopper.getId());</span>
<span class="fc" id="L131">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L132">                        .body(Map.of(&quot;error&quot;, &quot;Failed to remove sharing&quot;));</span>
            }

<span class="fc" id="L135">        } catch (Exception e) {</span>
<span class="fc" id="L136">            logger.error(&quot;Error removing sharing for cart {}: {}&quot;, cartId, e.getMessage(), e);</span>
<span class="fc" id="L137">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L138">                    .body(Map.of(&quot;error&quot;, &quot;Internal server error: &quot; + e.getMessage()));</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>