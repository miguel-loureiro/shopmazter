<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShopCartSeeder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">supershopcart</a> &gt; <a href="index.source.html" class="el_package">com.supershopcart.seeder</a> &gt; <span class="el_source">ShopCartSeeder.java</span></div><h1>ShopCartSeeder.java</h1><pre class="source lang-java linenums">package com.supershopcart.seeder;

import com.google.api.core.ApiFuture;
import com.google.cloud.firestore.Firestore;
import com.google.cloud.firestore.WriteResult;
import com.supershopcart.models.GroceryItem;
import com.supershopcart.models.ShopCart;
import com.supershopcart.models.Shopper;
import com.supershopcart.repositories.ShopCartRepository;
import com.supershopcart.repositories.ShopperRepository;
import com.supershopcart.services.FirestoreService;
import com.supershopcart.services.ShopCartService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier; // Import Qualifier
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Component;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.TimeUnit;

// Add a logger for this class
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.cloud.firestore.Firestore;
import com.google.cloud.firestore.WriteResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

@Component
@Profile(&quot;dev-emulator&quot;) // Only runs when this profile is active
public class ShopCartSeeder implements CommandLineRunner {


    // go to http://127.0.0.1:4001/firestore/default/data/ to see the data populated !!!
<span class="fc" id="L48">    private static final Logger logger = LoggerFactory.getLogger(ShopCartSeeder.class);</span>
    private final ShopCartService shopCartService;
    private final ShopCartRepository shopCartRepository; // Inject ShopCartRepository directly
    private final ShopperRepository shopperRepository;
    private final BCryptPasswordEncoder passwordEncoder;

    // Updated constructor to inject both repositories
    public ShopCartSeeder(ShopCartService shopCartService,
                          ShopCartRepository shopCartRepository, // New injection
<span class="fc" id="L57">                          ShopperRepository shopperRepository) {</span>
<span class="fc" id="L58">        this.shopCartService = shopCartService;</span>
<span class="fc" id="L59">        this.shopCartRepository = shopCartRepository; // Assign new injection</span>
<span class="fc" id="L60">        this.shopperRepository = shopperRepository;</span>
<span class="fc" id="L61">        this.passwordEncoder = new BCryptPasswordEncoder();</span>
<span class="fc" id="L62">    }</span>

    @Override
    public void run(String... args) throws Exception {
<span class="fc" id="L66">        logger.info(&quot;ðŸš€ Running ShopCartSeeder for 'dev-emulator' profile...&quot;);</span>

        // Clear existing data before seeding to ensure a clean state for testing
<span class="fc" id="L69">        logger.info(&quot;Clearing existing data from Firestore emulator...&quot;);</span>
        try {
            // Clear ShopCarts first, as they contain shopper IDs (though not strictly necessary for deletion order)
<span class="fc" id="L72">            shopCartRepository.deleteAll(); // Requires this method in ShopCartRepository</span>
<span class="fc" id="L73">            logger.info(&quot;All ShopCart documents cleared.&quot;);</span>

            // Then clear Shoppers
<span class="fc" id="L76">            shopperRepository.deleteAll(); // Requires this method in ShopperRepository</span>
<span class="fc" id="L77">            logger.info(&quot;All Shopper documents cleared.&quot;);</span>
<span class="nc" id="L78">        } catch (ExecutionException | InterruptedException e) {</span>
<span class="nc" id="L79">            logger.error(&quot;Error clearing existing data: {}&quot;, e.getMessage());</span>
<span class="nc" id="L80">            throw new RuntimeException(&quot;Failed to clear existing data before seeding&quot;, e);</span>
<span class="fc" id="L81">        }</span>
<span class="fc" id="L82">        logger.info(&quot;Existing data cleared successfully.&quot;);</span>


        // 1. Seed Shoppers
<span class="fc" id="L86">        logger.info(&quot;Seeding shoppers...&quot;);</span>
        Shopper shopper1;
        Shopper shopper2;
        Shopper shopper3;

        try {
<span class="fc" id="L92">            shopper1 = new Shopper(&quot;seeder.alice@example.com&quot;, &quot;Alice Seeder&quot;, passwordEncoder.encode(&quot;pass123&quot;));</span>
<span class="fc" id="L93">            shopper1.setShopCartIds(new ArrayList&lt;&gt;()); // Initialize list</span>
<span class="fc" id="L94">            shopper1 = shopperRepository.save(shopper1); // Save and get the ID back</span>

<span class="fc" id="L96">            shopper2 = new Shopper(&quot;seeder.bob@example.com&quot;, &quot;Bob Seeder&quot;, passwordEncoder.encode(&quot;securepass&quot;));</span>
<span class="fc" id="L97">            shopper2.setShopCartIds(new ArrayList&lt;&gt;()); // Initialize list</span>
<span class="fc" id="L98">            shopper2 = shopperRepository.save(shopper2);</span>

<span class="fc" id="L100">            shopper3 = new Shopper(&quot;seeder.charlie@example.com&quot;, &quot;Charlie Seeder&quot;, passwordEncoder.encode(&quot;charliepass&quot;));</span>
<span class="fc" id="L101">            shopper3.setShopCartIds(new ArrayList&lt;&gt;()); // Initialize list</span>
<span class="fc" id="L102">            shopper3 = shopperRepository.save(shopper3);</span>

<span class="fc" id="L104">            logger.info(&quot;Seeded Shoppers: {}, {}, {}&quot;, shopper1.getEmail(), shopper2.getEmail(), shopper3.getEmail());</span>
<span class="nc" id="L105">        } catch (ExecutionException | InterruptedException e) {</span>
<span class="nc" id="L106">            logger.error(&quot;Failed to seed shoppers: {}&quot;, e.getMessage());</span>
<span class="nc" id="L107">            throw new RuntimeException(&quot;Failed to seed shoppers&quot;, e);</span>
<span class="fc" id="L108">        }</span>

        // Get today's date key
<span class="fc" id="L111">        String todayDateKey = LocalDate.now().format(DateTimeFormatter.ISO_DATE);</span>
<span class="fc" id="L112">        String yesterdayDateKey = LocalDate.now().minusDays(1).format(DateTimeFormatter.ISO_DATE);</span>

        // 2. Seed ShopCarts
<span class="fc" id="L115">        logger.info(&quot;Seeding shop carts...&quot;);</span>

        try {
            // Cart 1: Alice's cart for today
<span class="fc" id="L119">            List&lt;GroceryItem&gt; aliceItems = Arrays.asList(</span>
                    new GroceryItem(&quot;Organic Milk&quot;, &quot;1 liter&quot;),
                    new GroceryItem(&quot;Whole Wheat Bread&quot;, &quot;1 loaf&quot;),
                    new GroceryItem(&quot;Eggs&quot;, &quot;1 dozen&quot;)
            );
            // Use shopper IDs (from the created shoppers) for linking
<span class="fc" id="L125">            ShopCart cart1 = shopCartService.createShopCart(todayDateKey, aliceItems, Collections.singletonList(shopper1.getEmail())); // Pass email</span>
<span class="fc" id="L126">            logger.info(&quot;Created ShopCart {} for Alice.&quot;, cart1.getId());</span>

            // Cart 2: Bob's cart for today, with one item purchased
<span class="fc" id="L129">            List&lt;GroceryItem&gt; bobItems = Arrays.asList(</span>
                    new GroceryItem(&quot;Chicken Breast&quot;, &quot;500g&quot;),
                    new GroceryItem(&quot;Broccoli&quot;, &quot;1 head&quot;),
                    new GroceryItem(&quot;Rice&quot;, &quot;1 kg&quot;)
            );
<span class="fc" id="L134">            ShopCart cart2 = shopCartService.createShopCart(todayDateKey, bobItems, Collections.singletonList(shopper2.getEmail())); // Pass email</span>
<span class="fc" id="L135">            shopCartService.markItemAsPurchased(cart2.getId(), &quot;Broccoli&quot;); // Mark one item as purchased</span>
<span class="fc" id="L136">            logger.info(&quot;Created ShopCart {} for Bob, marked Broccoli as purchased.&quot;, cart2.getId());</span>

            // Cart 3: Shared cart for yesterday (Alice &amp; Charlie)
<span class="fc" id="L139">            List&lt;GroceryItem&gt; sharedItems = Arrays.asList(</span>
                    new GroceryItem(&quot;Coffee Beans&quot;, &quot;250g&quot;),
                    new GroceryItem(&quot;Sugar&quot;, &quot;500g&quot;)
            );
<span class="fc" id="L143">            ShopCart cart3 = shopCartService.createShopCart(yesterdayDateKey, sharedItems, Arrays.asList(shopper1.getEmail(), shopper3.getEmail())); // Pass emails</span>
<span class="fc" id="L144">            logger.info(&quot;Created shared ShopCart {} for Alice and Charlie.&quot;, cart3.getId());</span>

            // Cart 4: Charlie's individual cart for today
<span class="fc" id="L147">            List&lt;GroceryItem&gt; charlieItems = Arrays.asList(</span>
                    new GroceryItem(&quot;Yogurt&quot;, &quot;4 units&quot;),
                    new GroceryItem(&quot;Fruit Mix&quot;, &quot;1 pack&quot;)
            );
<span class="fc" id="L151">            ShopCart cart4 = shopCartService.createShopCart(todayDateKey, charlieItems, Collections.singletonList(shopper3.getEmail())); // Pass email</span>
<span class="fc" id="L152">            logger.info(&quot;Created ShopCart {} for Charlie.&quot;, cart4.getId());</span>

<span class="fc" id="L154">            logger.info(&quot;âœ… ShopCartSeeder finished. {} shoppers and {} carts seeded.&quot;,</span>
<span class="fc" id="L155">                    shopperRepository.findAll().size(), shopCartService.getAllShopCarts().size()); // Get actual counts</span>
<span class="nc" id="L156">        } catch (ExecutionException | InterruptedException | IllegalArgumentException e) { // Catch IllegalArgumentException for shopper not found</span>
<span class="nc" id="L157">            logger.error(&quot;Failed to seed shop carts: {}&quot;, e.getMessage());</span>
<span class="nc" id="L158">            throw new RuntimeException(&quot;Failed to seed shop carts&quot;, e);</span>
<span class="fc" id="L159">        }</span>
<span class="fc" id="L160">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>