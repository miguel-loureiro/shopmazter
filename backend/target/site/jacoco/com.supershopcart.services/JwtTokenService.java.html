<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtTokenService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">supershopcart</a> &gt; <a href="index.source.html" class="el_package">com.supershopcart.services</a> &gt; <span class="el_source">JwtTokenService.java</span></div><h1>JwtTokenService.java</h1><pre class="source lang-java linenums">package com.supershopcart.services;

import com.supershopcart.models.Shopper;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;


@Component
<span class="fc" id="L21">public class JwtTokenService {</span>

<span class="fc" id="L23">    private static final Logger logger = LoggerFactory.getLogger(JwtTokenService.class);</span>

    @Value(&quot;${jwt.secret}&quot;)
    private String secretKeyString;

    @Value(&quot;${jwt.access-token.expiration}&quot;) // 1 hour default
    private long accessTokenExpiration;

    @Value(&quot;${jwt.refresh-token.expiration}&quot;) // 30 days default
    private long refreshTokenExpiration;

    private SecretKey secretKey;

    @PostConstruct
    private void initializeSecretKey() {
        try {
<span class="fc" id="L39">            logger.info(&quot;=== JWT Service Initialization Debug ===&quot;);</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">            logger.info(&quot;Secret key string: {}&quot;, secretKeyString != null ? &quot;[PRESENT]&quot; : &quot;[NULL]&quot;);</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">            logger.info(&quot;Secret key length: {}&quot;, secretKeyString != null ? secretKeyString.length() : 0);</span>
<span class="fc" id="L42">            logger.info(&quot;Access token expiration: {}&quot;, accessTokenExpiration);</span>
<span class="fc" id="L43">            logger.info(&quot;Refresh token expiration: {}&quot;, refreshTokenExpiration);</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">            if (secretKeyString == null) {</span>
<span class="fc" id="L46">                throw new IllegalStateException(&quot;JWT secret is null - check your application.properties&quot;);</span>
            }

<span class="fc bfc" id="L49" title="All 2 branches covered.">            if (secretKeyString.trim().isEmpty()) {</span>
<span class="fc" id="L50">                throw new IllegalStateException(&quot;JWT secret is empty - check your application.properties&quot;);</span>
            }

<span class="fc" id="L53">            byte[] keyBytes = secretKeyString.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L54">            logger.info(&quot;Original key bytes length: {}&quot;, keyBytes.length);</span>

            // Ensure the key is at least 256 bits (32 bytes) for HS256
<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (keyBytes.length &lt; 32) {</span>
<span class="fc" id="L58">                logger.warn(&quot;JWT secret key is shorter than 32 bytes (256 bits). Padding it to meet HS256 requirements.&quot;);</span>
<span class="fc" id="L59">                byte[] paddedKey = new byte[32];</span>
<span class="fc" id="L60">                System.arraycopy(keyBytes, 0, paddedKey, 0, keyBytes.length);</span>
                // Fill the rest with zeros if needed
<span class="fc bfc" id="L62" title="All 2 branches covered.">                for (int i = keyBytes.length; i &lt; 32; i++) {</span>
<span class="fc" id="L63">                    paddedKey[i] = 0;</span>
                }
<span class="fc" id="L65">                keyBytes = paddedKey; // Use the padded key</span>
<span class="fc" id="L66">                logger.info(&quot;Padded key bytes length: {}&quot;, keyBytes.length);</span>
            }

<span class="fc" id="L69">            this.secretKey = Keys.hmacShaKeyFor(keyBytes); // Use the potentially padded keyBytes</span>

<span class="fc" id="L71">            logger.info(&quot;JWT secret key initialized successfully!&quot;);</span>

<span class="fc" id="L73">        } catch (Exception e) {</span>
<span class="fc" id="L74">            logger.error(&quot;FAILED to initialize JWT secret key&quot;, e);</span>
<span class="fc" id="L75">            logger.error(&quot;Exception type: {}&quot;, e.getClass().getSimpleName());</span>
<span class="fc" id="L76">            logger.error(&quot;Exception message: {}&quot;, e.getMessage());</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (e.getCause() != null) {</span>
<span class="nc" id="L78">                logger.error(&quot;Caused by: {}&quot;, e.getCause().getMessage());</span>
            }
<span class="fc" id="L80">            throw e;</span>
<span class="fc" id="L81">        }</span>
<span class="fc" id="L82">    }</span>

    public long getRefreshTokenExpiration() {
<span class="fc" id="L85">        return refreshTokenExpiration;</span>
    }

    /**
     * Generate access token for shopper
     */
    public String generateAccessToken(Shopper shopper) {
<span class="fc" id="L92">        return generateAccessToken(shopper.getId(), null);</span>
    }

    /**
     * Generate access token with custom claims
     */
    public String generateAccessToken(String shopperId, String deviceId) {

<span class="fc" id="L100">        Map&lt;String, Object&gt; claims = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L101" title="1 of 4 branches missed.">        if (deviceId != null &amp;&amp; !deviceId.trim().isEmpty()) {</span>
<span class="fc" id="L102">            claims.put(&quot;deviceId&quot;, deviceId);</span>
        }

<span class="fc bfc" id="L105" title="All 4 branches covered.">        if (shopperId == null || shopperId.trim().isEmpty()) {</span>
<span class="fc" id="L106">            throw new IllegalArgumentException(&quot;Shopper ID cannot be null or empty&quot;);</span>
        }

        try {
<span class="fc" id="L110">            return Jwts.builder()</span>
<span class="fc" id="L111">                    .claims(claims)</span>
<span class="fc" id="L112">                    .subject(shopperId)</span>
<span class="fc" id="L113">                    .issuedAt(new Date())</span>
<span class="fc" id="L114">                    .expiration(new Date(System.currentTimeMillis() + accessTokenExpiration))</span>
<span class="fc" id="L115">                    .signWith(secretKey, Jwts.SIG.HS256)</span>
<span class="fc" id="L116">                    .compact();</span>

<span class="fc" id="L118">        } catch (Exception e) {</span>
<span class="fc" id="L119">            logger.error(&quot;Failed to generate access token for shopper: {}&quot;, shopperId, e);</span>
<span class="fc" id="L120">            throw new RuntimeException(&quot;Token generation failed&quot;, e);</span>
        }
    }

    /**
     * Generate refresh token for shopper
     */
    public String generateRefreshToken(Shopper shopper) {
<span class="fc" id="L128">        return generateRefreshToken(shopper.getId());</span>
    }

    /**
     * Generate refresh token for shopper ID
     */
    public String generateRefreshToken(String shopperId) {
<span class="pc bpc" id="L135" title="1 of 4 branches missed.">        if (shopperId == null || shopperId.trim().isEmpty()) {</span>
<span class="fc" id="L136">            throw new IllegalArgumentException(&quot;Shopper ID cannot be null or empty&quot;);</span>
        }

        try {
<span class="fc" id="L140">            return Jwts.builder()</span>
<span class="fc" id="L141">                    .subject(shopperId)</span>
<span class="fc" id="L142">                    .issuedAt(new Date())</span>
<span class="fc" id="L143">                    .expiration(new Date(System.currentTimeMillis() + refreshTokenExpiration))</span>
<span class="fc" id="L144">                    .signWith(secretKey, Jwts.SIG.HS256)</span>
<span class="fc" id="L145">                    .compact();</span>

<span class="nc" id="L147">        } catch (Exception e) {</span>
<span class="nc" id="L148">            logger.error(&quot;Failed to generate refresh token for shopper: {}&quot;, shopperId, e);</span>
<span class="nc" id="L149">            throw new RuntimeException(&quot;Token generation failed&quot;, e);</span>
        }
    }

    /**
     * Extract shopper ID from JWT token
     */
    public String extractShopperId(String token) {
<span class="fc bfc" id="L157" title="All 4 branches covered.">        if (token == null || token.trim().isEmpty()) {</span>
<span class="fc" id="L158">            return null;</span>
        }

        try {
<span class="fc" id="L162">            Claims claims = Jwts.parser()</span>
<span class="fc" id="L163">                    .verifyWith(secretKey)</span>
<span class="fc" id="L164">                    .build()</span>
<span class="fc" id="L165">                    .parseSignedClaims(token)</span>
<span class="fc" id="L166">                    .getPayload();</span>

<span class="fc" id="L168">            String shopperId = claims.getSubject();</span>

<span class="pc bpc" id="L170" title="2 of 4 branches missed.">            if (shopperId == null || shopperId.trim().isEmpty()) {</span>
<span class="nc" id="L171">                logger.warn(&quot;JWT subject (shopper ID) is empty or null&quot;);</span>
<span class="nc" id="L172">                return null;</span>
            }

            // Validate that it's a valid number format if needed
            // Removed Long.parseLong validation as it's not universally required for shopper IDs
            // and can be handled at a higher layer if specific ID format is enforced.
<span class="fc" id="L178">            return shopperId;</span>

<span class="fc" id="L180">        } catch (JwtException e) {</span>
<span class="fc" id="L181">            logger.debug(&quot;Invalid JWT token: {}&quot;, e.getMessage());</span>
<span class="fc" id="L182">            return null;</span>
<span class="nc" id="L183">        } catch (Exception e) {</span>
<span class="nc" id="L184">            logger.error(&quot;Unexpected error parsing JWT token&quot;, e, e.getCause()); // Log cause</span>
<span class="nc" id="L185">            return null;</span>
        }
    }

    /**
     * Extract all claims from token
     */
    public Claims extractAllClaims(String token) {
<span class="fc bfc" id="L193" title="All 4 branches covered.">        if (token == null || token.trim().isEmpty()) {</span>
<span class="fc" id="L194">            return null;</span>
        }

        try {
<span class="fc" id="L198">            return Jwts.parser()</span>
<span class="fc" id="L199">                    .verifyWith(secretKey)</span>
<span class="fc" id="L200">                    .build()</span>
<span class="fc" id="L201">                    .parseSignedClaims(token)</span>
<span class="fc" id="L202">                    .getPayload();</span>

<span class="fc" id="L204">        } catch (JwtException e) {</span>
<span class="fc" id="L205">            logger.debug(&quot;Invalid JWT token: {}&quot;, e.getMessage());</span>
<span class="fc" id="L206">            return null;</span>
<span class="nc" id="L207">        } catch (Exception e) {</span>
<span class="nc" id="L208">            logger.error(&quot;Unexpected error extracting claims from JWT token&quot;, e, e.getCause()); // Log cause</span>
<span class="nc" id="L209">            return null;</span>
        }
    }

    /**
     * Check if token is expired
     */
    public boolean isTokenExpired(String token) {
        try {
<span class="fc" id="L218">            Claims claims = extractAllClaims(token);</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">            if (claims != null) {</span>
<span class="fc" id="L220">                Date expiration = claims.getExpiration();</span>
<span class="pc bpc" id="L221" title="2 of 4 branches missed.">                return expiration != null &amp;&amp; expiration.before(new Date());</span>
            }
<span class="fc" id="L223">            return true; // Consider invalid tokens as expired</span>
<span class="nc" id="L224">        } catch (Exception e) {</span>
<span class="nc" id="L225">            logger.debug(&quot;Error checking token expiration: {}&quot;, e.getMessage());</span>
<span class="nc" id="L226">            return true; // If extraction fails, consider it expired/invalid</span>
        }
    }

    /**
     * Validate token for specific shopper
     */
    public boolean isTokenValid(String token, String shopperId) {
<span class="fc bfc" id="L234" title="All 4 branches covered.">        if (token == null || shopperId == null) {</span>
<span class="fc" id="L235">            return false;</span>
        }

        try {
<span class="fc" id="L239">            String extractedShopperId = extractShopperId(token);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">            return extractedShopperId != null &amp;&amp;</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">                    extractedShopperId.equals(shopperId) &amp;&amp;</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">                    !isTokenExpired(token);</span>
<span class="nc" id="L243">        } catch (Exception e) {</span>
<span class="nc" id="L244">            logger.debug(&quot;Error validating token for shopper {}: {}&quot;, shopperId, e.getMessage());</span>
<span class="nc" id="L245">            return false;</span>
        }
    }

    /**
     * Validate if token is valid (not expired)
     */
    public boolean isTokenValid(String token) {
<span class="fc bfc" id="L253" title="All 4 branches covered.">        if (token == null || token.trim().isEmpty()) {</span>
<span class="fc" id="L254">            return false;</span>
        }

        try {
<span class="pc bpc" id="L258" title="1 of 4 branches missed.">            return extractAllClaims(token) != null &amp;&amp; !isTokenExpired(token);</span>
<span class="nc" id="L259">        } catch (Exception e) {</span>
<span class="nc" id="L260">            logger.debug(&quot;JWT token validation failed: {}&quot;, e.getMessage());</span>
<span class="nc" id="L261">            return false;</span>
        }
    }

    /**
     * Get token expiration date
     */
    public Date getExpirationDate(String token) {
        try {
<span class="fc" id="L270">            Claims claims = extractAllClaims(token);</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">            return claims != null ? claims.getExpiration() : null;</span>
<span class="nc" id="L272">        } catch (Exception e) {</span>
<span class="nc" id="L273">            logger.debug(&quot;Error getting expiration date from token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L274">            return null;</span>
        }
    }

    /**
     * Get token issued date
     */
    public Date getIssuedDate(String token) {
        try {
<span class="fc" id="L283">            Claims claims = extractAllClaims(token);</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">            return claims != null ? claims.getIssuedAt() : null;</span>
<span class="nc" id="L285">        } catch (Exception e) {</span>
<span class="nc" id="L286">            logger.debug(&quot;Error getting issued date from token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L287">            return null;</span>
        }
    }

    /**
     * Generate token pair (access + refresh)
     */
    public TokenPair generateTokenPair(Shopper shopper) {
<span class="fc" id="L295">        String accessToken = generateAccessToken(shopper);</span>
<span class="fc" id="L296">        String refreshToken = generateRefreshToken(shopper);</span>
<span class="fc" id="L297">        return new TokenPair(accessToken, refreshToken);</span>
    }

    /**
     * Token pair container class
     */
    public static class TokenPair {
        private final String accessToken;
        private final String refreshToken;

<span class="fc" id="L307">        public TokenPair(String accessToken, String refreshToken) {</span>
<span class="fc" id="L308">            this.accessToken = accessToken;</span>
<span class="fc" id="L309">            this.refreshToken = refreshToken;</span>
<span class="fc" id="L310">        }</span>

        public String getAccessToken() {
<span class="fc" id="L313">            return accessToken;</span>
        }

        public String getRefreshToken() {
<span class="fc" id="L317">            return refreshToken;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>